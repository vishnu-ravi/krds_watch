<div class="container-fluid">
    <link rel="stylesheet" href="/stylesheet/jquery.tag-editor.css">
    <link rel="stylesheet" href="/stylesheet/jquery-ui.min.css">
    {{> nav this}}
    <div class="row">
        <form>
            <div class="form-group row">
                <label for="description" class="col-sm-4 form-control-label">Description</label>
                <div class="col-sm-8">
                    <input class="form-control" type="text" id="description" name="description" placeholder="Description" {{#if post}} value="{{post.description}}" {{/if}} />
                </div>
            </div>
            <div class="form-group row">
                <label for="url" class="col-sm-4 form-control-label">URL</label>
                <div class="col-sm-8">
                    <input class="form-control" type="text" id="url" name="url" placeholder="URL" {{#if post}} value="{{post.url}}" {{/if}}/>
                </div>
            </div>
            <div class="form-group row defaultHidden" id="post_preview_container">
                <label class="col-sm-4 form-control-label">Preview</label>
                <div class="col-sm-8">
                    <div class="row">
                        <div class="loader hidden" style="height:400px;"></div>
                        <div class="col-sm-4">
                            <img id="preview_image" src="/images/setting_icon.png" alt="Preview Image" class="img-thumbnail img-responsive">
                        </div>
                        <div class="col-sm-8">
                            <h3 id="preview_title">Title</h3>
                            <p id="preview_description">Description</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="tags" class="col-sm-4 form-control-label">Tags</label>
                <div class="col-sm-8">
                    <input type="text" id="tags" class="form-control" name="tags" placeholder="Tags"/>
                </div>
            </div>
            <div class="form-group row">
                <label for="highlight" class="col-sm-4 form-control-label">Highlight</label>
                <div class="col-sm-8">
                    <label class="radio-inline">
                      <input type="radio" name="highlight" id="highlight_yes" value="1" checked="false"> Yes
                    </label>
                    <label class="radio-inline">
                      <input type="radio" name="highlight" id="highlight_no" value="0" checked="checked"> No
                    </label>
                </div>
            </div>
            <div class="form-group row">
                <label for="categories" class="col-sm-4 form-control-label">Category</label>
                <div class="col-sm-8">
                    <input type="text" id="categories" class="form-control" name="categories" placeholder="Categories"/>
                </div>
            </div>

            <div class="form-group row">
                <div class="col-sm-offset-4 col-sm-8">
                    <button id="btn_submit" type="submit" class="btn btn-primary">Save</button>
                </div>
            </div>
            <div class="alert" id="alert_info" role="alert" style="display:none;"></div>
        </form>
    </div>
</div>
<script src="/javascript/lib/jquery-ui.min.js"></script>
<script src="/javascript/lib/jquery.tag-editor.min.js"></script>
<script src="/javascript/lib/jquery.caret.min.js"></script>
<script>
    var categories  =   "{{categories}}";
    var tags        =   "{{tags}}";
    var id_user     =   "{{user.id_user}}";
    var json        =   "{{post_json}}";
    var post_json;
    var is_edit     =   false;
    var id_post     =   null;
    if(json != '')
    {
        post_json   =   json.replace(/\\n/g, "\\n")
                           .replace(/\\'/g, "\\'")
                           .replace(/\\"/g, '\\"')
                           .replace(/\\&/g, "\\&")
                           .replace(/\\r/g, "\\r")
                           .replace(/\\t/g, "\\t")
                           .replace(/\\b/g, "\\b")
                           .replace(/\\f/g, "\\f")
                           .replace(/[\u0000-\u0019]+/g,"")
                           .replace(/&quot;/g,'"');
        post_json   =   JSON.parse(post_json);
    }


    categories      =   categories.split(',');
    tags            =   tags.split(',');

    var initialTags =   typeof post_json != 'undefined' ? post_json.tags : [];
    var initalCategories    =   typeof post_json != 'undefined' ? post_json.categories : [];

    $(document).ready(function()
    {
        $('#tags').tagEditor({
            initialTags: initialTags,
            delimiter: ', ', /* space and comma */
            placeholder: 'Enter Tags ...',
            autocomplete: {
                delay: 0, // show suggestions immediately
                position: { collision: 'flip' }, // automatic menu position up/down
                source: tags
            },
        });

        $('#categories').tagEditor({
            initialTags: initalCategories,
            delimiter: ', ', /* space and comma */
            placeholder: 'Enter Categories ...',
            forceLowercase: false,
            removeDuplicates: true,
            autocomplete: {
                delay: 0, // show suggestions immediately
                position: { collision: 'flip' }, // automatic menu position up/down
                source: categories
            },
            onChange: function(field, editor, tags)
            {
                if(tags.length)
                {
                    var to_be_removed = $.grep(tags, function(el){return $.inArray(el, categories) == -1});
                    if(to_be_removed.length)
                    {
                        $.each(to_be_removed, function(key, val)
                        {
                            $('#categories').tagEditor('removeTag', val);
                        });
                    }
                }
            }
        });
        var expression  =   /[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi;
        var regex       =   new RegExp(expression);
        var busy        =    false;
        $('#url').on('keyup', function()
        {
            if( ! $(this).val().match(regex))
            {
                $('#alert_info').html('Invalid Url').addClass('alert-error').show();
                return false;
            }

            if(busy)
                return;

            busy    =   true;
            $('#btn_submit').addClass('disabled');
            $.ajax({
                cache: false,
                type: 'POST',
                url: '/post/url',
                dataType: 'json',
                data: {
                    url: $(this).val()
                },
                error: function(jXhr) {
                    if(jXhr.status == 400 || jXhr.status == 500 || jXhr.status == 403)
                        $('#alert_info').html(jXhr.msg).addClass('alert-error').show();
                },
                success: function(data) {
                    $('#preview_image').attr('src', data.image);
                    $('#preview_title').html(data.title);
                    $('#preview_description').html(data.description);
                    $('#post_preview_container').show();
                },
                complete: function(){
                    busy    =   false;
                    $('#btn_submit').removeClass('disabled');
                }
            });
        });

        $('#btn_submit').on('click', function(e)
        {
            e.preventDefault();

            if(busy)
                return;

            busy    =   true;

            try
            {
                if($('#url').val().length == 0)
                    throw {msg: 'Empty URL', ele: '#url'};

                if( ! $('#url').val().match(regex))
                    throw {msg: 'Invalid URL', ele: '#url'};

                if($('#categories').tagEditor('getTags')[0].tags.length == 0)
                    throw {msg: 'No Category Selected'};
                $('body').addClass('loading');

                var data    =   {
                    id_user: id_user,
                    description: $.trim($('#description').val()),
                    url: $.trim($('#url').val()),
                    tags: $('#tags').tagEditor('getTags')[0].tags,
                    is_highlighted: $("input[type='radio'][name='highlight']:checked").val(),
                    categories: $('#categories').tagEditor('getTags')[0].tags,
                    title: $('#preview_title').html(),
                    preview_description: $('#preview_description').html(),
                    image: $('#preview_image').attr('src')
                };

                var method  =   is_edit ? 'PUT' : 'POST';

                if(is_edit)
                    data.id_post    =   id_post;

                $.ajax({
                    cache: false,
                    type: method,
                    url: '/post/',
                    dataType: 'json',
                    data: {data: JSON.stringify(data)},
                    error: function(jXhr) {
                        if(jXhr.status == 400 || jXhr.status == 500 || jXhr.status == 403)
                            $('#alert_info').html(jXhr.msg).addClass('alert-error').show();

                        $('body').removeClass('loading');    
                    },
                    success: function(data) {
                        $('body').addClass('loading');
                        location.href =   '/home';
                    },
                    complete: function(){
                        busy    =   false;
                    }
                });
            }
            catch (e)
            {
                if(e.ele)
                    $(e.ele).focus();

                $('#alert_info').html(e.msg).addClass('alert-error').show();
            }
        });

        if(post_json != null)
        {
            if(post_json.is_highlighted)
                $('#highlight_yes').prop('checked', true);
            else
                $('#highlight_no').prop('checked', true);

            $('#url').trigger('keyup');

            is_edit =   true;
            id_post =   post_json._id;
        }
    });
</script>
